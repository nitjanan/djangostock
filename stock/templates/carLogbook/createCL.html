{% extends 'layouts.html' %}
{% load crispy_forms_tags %}
{% load humanize %}
{% load static %}
{% load widget_tweaks %}
{% load templatehelpers %}
{% block css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">

<!-- Boostrap 4 icon -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<style>
    @media (min-width: 360px) { /* Styles for screens 768px and wider */
        .select2-container .select2-selection {
            width: 70vw !important;
            height: 37px !important;
            line-height: 50px !important;
            padding: 5px 12px;
            border-radius: 4px;
        }

        .select2-container {
            width: 70vw !important;
        }
    }

    @media (min-width: 768px) { /* Styles for screens 1200px and wider */
        .select2-container .select2-selection {
            width: 66.5vw !important;
            height: 37px !important;
            line-height: 50px !important;
            padding: 5px 12px;
            border-radius: 4px;
        }

        .select2-container {
            width: 66.5vw !important;
        }
    }

    @media (min-width: 1200px) { /* Styles for screens 1200px and wider */
        .select2-container .select2-selection {
            width: 55.5vw !important;
            height: 37px !important;
            line-height: 50px !important;
            padding: 5px 7px;
            border-radius: 4px;
            border: 1px solid #ced4da;
        }

        .select2-container {
            width: 55.5vw !important;
        }
    }
    
    .big-checkbox{
        width: 16px; /* Adjust the width as needed */
        height: 16px; /* Adjust the height as needed */
        transform: scale(1.15); /* Adjust the scale as needed */
        -webkit-transform: scale(1.15); /* For Safari and Chrome */
        -moz-transform: scale(1.15); /* For Firefox */
        -ms-transform: scale(1.15); /* For Internet Explorer */
        -o-transform: scale(1.15); /* For Opera */
    }

    .inline-checkboxes{
        display: inline-block;
        margin-right: 15px; /* Adjust spacing as needed */
    }

    #preview-image_mile {
            max-width: 200px; 
            display: none; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 5px;
    }

    .upload-label {
            background-color: white; 
            padding: 6px 20px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            cursor: pointer; 
            width: 100%; 
            height: 40px; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
    }

            .custom-combobox {
            position: relative;
            display: inline-block;
        }
        .custom-combobox-toggle {
            position: absolute;
            top: 0;
            bottom: 0;
            margin-left: -1px;
            padding: 0;
        }
        .custom-combobox-input {
            margin: 0;
            padding: 5px 10px;
        }
</style>
{% endblock %}

{% block content %}

<div class="container my-3">
    <h2 align="center">บันทึกการใช้รถ</h2>
    <div class="card bg-light">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                <!--p>{{ form | crispy}}</!--p-->
                <p>
                    <label for="id_created">วันที่บันทึกการใช้รถ:</label>
                    {{ form.created }}
                </p>
                <p>
                    {{ form.name.label_tag }}
                    {{ form.name }}
                </p>
                <p>
                    {{ form.branch_company }}
                </p>
                <p>
                    {{ form.car.label_tag }}
                    {{ form.car}}
                </p>
                <hr class="border border-success">
                <p>
                    {{ form.image_mile.label_tag}}
                    <input type="file" 
                        name="image_mile" 
                        accept="image/*" 
                        id="id_image_mile" 
                        style="display: none;" 
                        oninvalid="this.setCustomValidity('กรุณาถ่ายรูปโลโก้')"
                        oninput="this.setCustomValidity('')">

                    <!-- Label as button -->
                    <label for="id_image_mile" class="upload-label" id="label_image_mile">
                        <i class="fas fa-camera"></i>&nbsp;ถ่ายรูปเลขไมล์เริ่มต้น
                    </label>

                    <!-- Preview container -->
                    <div id="preview-container" style="margin-top: 10px;">
                        <img id="preview-image_mile" src="" alt="Preview โลโก้">
                    </div>
                </p>

                <p>
                    {{ form.mile_start.label_tag }}
                    <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default"><i class="bi bi-speedometer2"></i></span>
                    </div>
                        {{ form.mile_start |attr:"required:true"}}
                    </div>
                </p>
                
                <p>
                    {{ form.mile_end.label_tag }}
                    <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default"><i class="bi bi-speedometer2"></i></span>
                    </div>
                        {{ form.mile_end |attr:"required:true"}}
                    </div>
                </p>

                <hr class="border border-primary">
                <p>
                    {{ form.job1.label_tag }}
                    {{ form.job1 }}

                </p>

                <div id="expense_dept_radios1">
                    <!-- Radios will be inserted here -->
                </div>

                <p>
                    {{ form.exd_job1 | add_class:"d-none"}}
                </p>

                <p>
                    {{ form.start_job1.label_tag }}
                    <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default"><i class="bi bi-alarm"></i></span>
                    </div>
                        {{ form.start_job1 }}
                    </div>
                </p>
                <p>
                    {{ form.end_job1.label_tag }}
                    <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default"><i class="bi bi-alarm"></i></span>
                    </div>
                        {{ form.end_job1 }}
                    </div>
                </p>

                <hr class="border border-primary">
                <p>
                    {{ form.job2.label_tag }}
                    <div class="input-group d-none">
                        <input id="job2_autocomplete" type="text" class="form-control" placeholder="ค้นหารายละเอียดงาน 2 ...">
                        <div class="input-group-append">
                            <button type="button" id="job2-show-all" class="btn btn-outline-secondary">▼</button>
                        </div>
                    </div>
                    {{ form.job2 }}
                </p>

                <div id="expense_dept_radios2">
                    <!-- Radios will be inserted here -->
                </div>
                <p>
                    {{ form.exd_job2 | add_class:"d-none"}}
                </p>

                <p>
                    {{ form.start_job2.label_tag }}
                    <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default"><i class="bi bi-alarm"></i></span>
                    </div>
                        {{ form.start_job2 }}
                    </div>
                </p>
                <p>
                    {{ form.end_job2.label_tag }}
                    <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default"><i class="bi bi-alarm"></i></span>
                    </div>
                        {{ form.end_job2 }}
                    </div>
                </p>
                <hr class="border border-primary">
                <p>
                    {{ form.job3.label_tag }}
                    <div class="input-group d-none">
                        <input id="job3_autocomplete" type="text" class="form-control" placeholder="ค้นหารายละเอียดงาน 3 ...">
                        <div class="input-group-append">
                            <button type="button" id="job3-show-all" class="btn btn-outline-secondary">▼</button>
                        </div>
                    </div>
                    {{ form.job3 }}
                </p>
                <div id="expense_dept_radios3">
                    <!-- Radios will be inserted here -->
                </div>
                <p>
                    {{ form.exd_job3 | add_class:"d-none"}}
                </p>
                <p>
                    {{ form.start_job3.label_tag }}
                    <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default"><i class="bi bi-alarm"></i></span>
                    </div>
                        {{ form.start_job3 }}
                    </div>
                </p>
                <p>
                    {{ form.end_job3.label_tag }}
                    <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default"><i class="bi bi-alarm"></i></span>
                    </div>
                        {{ form.end_job3 }}
                    </div>
                </p>
                <hr class="border border-primary">
                <p>
                    {{ form.job4.label_tag }}
                    <div class="input-group d-none">
                        <input id="job4_autocomplete" type="text" class="form-control" placeholder="ค้นหารายละเอียดงาน 4 ...">
                        <div class="input-group-append">
                            <button type="button" id="job4-show-all" class="btn btn-outline-secondary">▼</button>
                        </div>
                    </div>
                    {{ form.job4 }}
                </p>
                <div id="expense_dept_radios4">
                    <!-- Radios will be inserted here -->
                </div>
                <p>
                    {{ form.exd_job4 | add_class:"d-none"}}
                </p>
                <p>
                    {{ form.start_job4.label_tag }}
                    <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default"><i class="bi bi-alarm"></i></span>
                    </div>
                        {{ form.start_job4 }}
                    </div>
                </p>
                <p>
                    {{ form.end_job4.label_tag }}
                    <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="inputGroup-sizing-default"><i class="bi bi-alarm"></i></span>
                    </div>
                        {{ form.end_job4 }}
                    </div>
                </p>
                <hr class="border border-primary">
                <p>
                    {{ form.note.label_tag }}
                    {{ form.note }}
                </p>

                <p>
                    {{ form.oil.label_tag }}
                    {{ form.oil }}
                </p>
                <p>
                    {{ form.gas.label_tag }}
                    {{ form.gas }}
                </p>
                <p>
                    {{ form.engine.label_tag }}
                    {{ form.engine }}
                </p>
                <p>
                    {{ form.hydraulic.label_tag }}
                    {{ form.hydraulic }}
                </p>
                <p>
                    {{ form.grease.label_tag }}
                    {{ form.grease }}
                </p>
                {% csrf_token %}
                <div class="row">
                    <div class="col-6">
                        <a href="{% url 'mobileMenu' %}" class="btn btn-lg btn-block btn-secondary" onclick="return confirm('คุณต้องการ Cancel หรือไม่ ?\n *** หาก Cancel ข้อมูลจะไม่ถูกบันทึก')">
                            Cancel
                        </a>
                    </div>
                    <div class="col-6">
                        <button type="submit" class="btn btn-lg btn-block btn-primary">
                            <i class="fas fa-save"></i>
                            บันทึก
                        </button>
                    </div>
                </div>
            </form>
        </div>
      </div>
</div>

{% endblock%}
{% block javascript %}
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
<!-- Select2 CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

<!-- Select2 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>
<script>
    let today = new Date().toISOString().split('T')[0];
    $('#id_created').val(today);

    $('#id_car').select2({
        ajax: {
            url: "{% url 'car_search' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term, // search term
                    'rq_type': 2,
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        },
        placeholder: 'ค้นหาด้วย code หรือ ชื่อ',
        minimumInputLength: 2,
        allowClear: true,
    });



    $('#id_name').css('pointer-events','none');
    
    $(function() {
        $('#id_job1').select2();
        $('#id_job2').select2();
        $('#id_job3').select2();
        $('#id_job4').select2();
        //setupAutocomplete("#job1_autocomplete", "#id_job1", "#job1-show-all", "{% url 'job_car_dep_autocomplete' %}");
        //setupAutocomplete("#job2_autocomplete", "#id_job2", "#job2-show-all", "{% url 'job_car_dep_autocomplete' %}");
        //setupAutocomplete("#job3_autocomplete", "#id_job3", "#job3-show-all", "{% url 'job_car_dep_autocomplete' %}");
        //setupAutocomplete("#job4_autocomplete", "#id_job4", "#job4-show-all", "{% url 'job_car_dep_autocomplete' %}");
        // add more as needed...
    });

    $('#id_car').on('change', function() {
        searchJobByCarDep("id_job1", 'expense_dept_radios1', 'id_exd_job1');
        searchJobByCarDep("id_job2", 'expense_dept_radios2', 'id_exd_job2');
        searchJobByCarDep("id_job3", 'expense_dept_radios3', 'id_exd_job3');
        searchJobByCarDep("id_job4", 'expense_dept_radios4', 'id_exd_job4');
    });

    function searchJobByCarDep(idJob, containerId, exdId){
        var tmpJob = $("#"+ idJob).val();
        var car = $("#id_car").val();

        let $container = $("#" + containerId);
        $container.empty();

        $("#" + exdId).val('');

        if(car != ""){
            // Create Ajax Call
            if(car){
                //set id_rq_type
                $.ajax({
                    url: '{% url "searchJobByCarDep" %}',
                    data:{
                            'car': car,
                        },
                    dataType: 'json',
                    success: function (data) {
                        if (data.job_list) {
                            $("#"+ idJob).find('option').not(':first').remove();
                            //set option 
                            for(var i = 0; i < data.job_list.length; i++){
                                $("#"+ idJob).append(new Option(data.job_list[i].name, data.job_list[i].id));
                            }
                        }
                        $('#'+ idJob +' option[value="'+tmpJob +'"]').attr('selected','selected');
                    }
                });
            }
            return false;
        }else{
           $("#"+ idJob).find('option').not(':first').remove();
        }
    }

    /*
    function setupAutocomplete(inputSelector, hiddenSelector, buttonSelector, url) {
        var $input = $(inputSelector);
        var $hidden = $(hiddenSelector);

        $input.autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: url,
                    dataType: "json",
                    data: { term: request.term , car : $("#id_car").val()},
                    success: function(data) {
                        response(data);
                    }
                });
            },
            minLength: 0,
            select: function(event, ui) {
                // set both inputs to the NAME
                $hidden.val(ui.item.value);
                $input.val(ui.item.label);
                return false;
            }
        });

        // Show all on ▼ click
        $(buttonSelector).on("click", function() {
            $input.autocomplete("search", "");
            $input.focus();
        });
    }
    */


    /*
    $('#job1_autocomplete').blur(function() {
        searchExpenseDeptByJob($('#id_job1').val(), 'expense_dept_radios1', 'id_exd_job1');
    });

    $('#job2_autocomplete').blur(function() {
        searchExpenseDeptByJob($('#id_job2').val(), 'expense_dept_radios2', 'id_exd_job2');
    });

    $('#job3_autocomplete').blur(function() {
        searchExpenseDeptByJob($('#id_job3').val(), 'expense_dept_radios3', 'id_exd_job3');
    });

    $('#job4_autocomplete').blur(function() {
        searchExpenseDeptByJob($('#id_job4').val(), 'expense_dept_radios4', 'id_exd_job4');
    });
    */



    $('#id_job1').on('change', function() {
        let job = $("#id_job1 option:selected").val();
        searchExpenseDeptByJob(job, 'expense_dept_radios1', 'id_exd_job1');
    });

    $('#id_job2').on('change', function() {
        let job = $("#id_job2 option:selected").val();
        searchExpenseDeptByJob(job, 'expense_dept_radios2', 'id_exd_job2');
    });

    $('#id_job3').on('change', function() {
        let job = $("#id_job3 option:selected").val();
        searchExpenseDeptByJob(job, 'expense_dept_radios2', 'id_exd_job3');
    });

    $('#id_job4').on('change', function() {
        let job = $("#id_job4 option:selected").val();
        searchExpenseDeptByJob(job, 'expense_dept_radios2', 'id_exd_job4');
    });

    $('#expense_dept_radios1').on('change', 'input[name="expense_dept_radios1"]', function() {
        var selectedValue = $(this).val();
        $('#id_exd_job1').val(selectedValue);
    });

    $('#expense_dept_radios2').on('change', 'input[name="expense_dept_radios2"]', function() {
        var selectedValue = $(this).val();
        $('#id_exd_job2').val(selectedValue);
    });

    $('#expense_dept_radios3').on('change', 'input[name="expense_dept_radios3"]', function() {
        var selectedValue = $(this).val();
        $('#id_exd_job3').val(selectedValue);
    });

    $('#expense_dept_radios4').on('change', 'input[name="expense_dept_radios4"]', function() {
        var selectedValue = $(this).val();
        $('#id_exd_job4').val(selectedValue);
    });
  
    function searchExpenseDeptByJob(job, containerId, exdId) {
        if (job !== "") {
            $.ajax({
                url: '{% url "searchExpenseDeptByJob" %}',
                data: {
                    'job_id': job,
                },
                dataType: 'json',
                success: function (data) {
                    let $container = $("#" + containerId);
                    $container.empty();

                    if (data.exd_job_list) {
                        if (data.exd_job_list.length === 1) {
                            // hide container
                            $container.hide();

                            // hidden + required + checked
                            let item = data.exd_job_list[0];
                            let $hiddenInput = $(`<input type="radio" name="${containerId}" value="${item.expense_dept__id}" checked required hidden>`);
                            // append to container
                            $("#" + containerId).append($hiddenInput);
                            // set another input's value
                            $("#" + exdId).val($hiddenInput.val());
                        } else {
                            // show container
                            $container.show();

                            data.exd_job_list.forEach(function(item, index) {
                                let required = index === 0 ? "required" : "";
                                let radioHtml = `
                                    <label>
                                        <input type="radio" name="${containerId}" value="${item.expense_dept__id}" ${required}>
                                        ${item.expense_dept__name}
                                    </label><br>
                                `;
                                $container.append(radioHtml);
                            });
                        }
                    }
                }
            });
        }else{
            $container.append(``);
        }
    }

    const inputFile = document.getElementById('id_image_mile');
    const previewImage = document.getElementById('preview-image_mile');

    inputFile.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
            }
            reader.readAsDataURL(file);
        } else {
            previewImage.src = '';
            previewImage.style.display = 'none';
        }
    });

    //before submit
    $('form').submit(function () {
        const submitButton = $(this).find("[type='submit']");
        submitButton.prop("disabled", true); //ปิดปุ่ม submit หากมีการกดซ้ำ

        if (inputFile.files.length < 1) {
            $("#id_mile_start").focus();
            alert('กรุณาถ่ายรูปเลขไมล์ก่อนส่งข้อมูล');

            submitButton.prop("disabled", false); // เปิดปุ่ม submit อีกครั้ง
            event.preventDefault(); // Prevent form submission
            return false;
        }
        if( $('#id_mile_end').val() < $('#id_mile_start').val()) {
            $("#id_mile_end").focus();
            alert('เลขไมล์สิ้นสุดน้อยกว่า เลขไมล์เริ่มต้น กรุณาคีย์ข้อมูลใหม่');

            submitButton.prop("disabled", false); // เปิดปุ่ม submit อีกครั้ง
            event.preventDefault(); // Prevent form submission
            return false;
        }

        if (!check_start_and_end_time('id_start_job1', 'id_end_job1')){
            submitButton.prop("disabled", false); // เปิดปุ่ม submit อีกครั้ง
            event.preventDefault(); // Prevent form submission
            return false;
        }
        if (!check_start_and_end_time('id_start_job2', 'id_end_job2')){
            submitButton.prop("disabled", false); // เปิดปุ่ม submit อีกครั้ง
            event.preventDefault(); // Prevent form submission
            return false;
        }
        if (!check_start_and_end_time('id_start_job3', 'id_end_job3')){
            submitButton.prop("disabled", false); // เปิดปุ่ม submit อีกครั้ง
            event.preventDefault(); // Prevent form submission
            return false;
        }
        if (!check_start_and_end_time('id_start_job4', 'id_end_job4')){
            submitButton.prop("disabled", false); // เปิดปุ่ม submit อีกครั้ง
            event.preventDefault(); // Prevent form submission
            return false;
        }

        return true; // ✅ ผ่านการตรวจสอบ
    });

    function check_start_and_end_time(id_start_time, id_end_time){
        let startVal = $('#' + id_start_time).val();
        let endVal = $('#' + id_end_time).val();
        if (startVal && endVal) {
            // แปลง string "HH:MM" เป็น Date object
            let startTime = new Date("1970-01-01T" + startVal + ":00");
            let endTime = new Date("1970-01-01T" + endVal + ":00");

            if (startTime > endTime) {
                $('#' + id_end_time).focus();
                alert('เวลาสิ้นสุดน้อยกว่าเวลาเริ่มต้น กรุณาคีย์ข้อมูลใหม่');
                return false;
            }
        }
        return true; // ✅ ผ่านการตรวจสอบ
    }

</script>
{% endblock%}
