{% extends 'layouts.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">

<style>
@media print {
    .hidden-print {
    display: none;
    }
}

/* Adjust the Select2 container */
.select2-container .select2-selection--single {
  height: 37px !important;
  line-height: 50px !important;
  padding: 5px 12px;
  border-radius: 4px;
  border: 1px solid #ced4da;
  width: 55.5vw !important;
}

/* Adjust the dropdown arrow height and alignment */
.select2-container .select2-selection--single .select2-selection__arrow {
  height: 37px !important;
  top: 0;
  right: 6px;
}

/* Ensure dropdown menu adapts properly */
.select2-container .select2-dropdown {
  border-radius: 4px;
  border: 1px solid #ced4da;
}

/* Align the clear button */
.select2-container .select2-selection__clear {
  line-height: 37px !important;
}

.custom-control-label::before{
  background-color:lightblue;
  width: 1.85rem;
  height: 1.85rem;
}
.custom-control-label::after {
  width: 1.85rem;
  height: 1.85rem;
}

.big-checkbox{
  width: 16px; /* Adjust the width as needed */
  height: 16px; /* Adjust the height as needed */
  transform: scale(1.15); /* Adjust the scale as needed */
  -webkit-transform: scale(1.15); /* For Safari and Chrome */
  -moz-transform: scale(1.15); /* For Firefox */
  -ms-transform: scale(1.15); /* For Internet Explorer */
  -o-transform: scale(1.15); /* For Opera */
}

.inline-checkboxes{
  display: inline-block;
  margin-right: 15px; /* Adjust spacing as needed */
}

</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row my-2">
    <div class="text-left col">
      <h4>{{requisition.address_company.name_th}}</h4>
    </div>
    <div class="text-right col">
      <h5>เลขที่. {{requisition.ref_no}}
        {% if requisition.memorandum_pdf %}
          {% ifchanged requisition.memorandum_pdf %}
            <a href="/media/{{requisition.memorandum_pdf}}" class="btn btn-outline-success btn-sm hidden-print"><i class="fas fa-file-download"></i> เอกสารแนบ</a>
          {% endifchanged %}
        {% endif %}
      </h5>
    </div>
  </div>
  <hr>
  <div class="row my-2">
    <div class="col-7 text-right">
        <h4>ใบขอเบิก{% if requisition.rq_type %} ({{requisition.rq_type}}){%endif%}</h4>
    </div>
    <div class="col-5 text-right">
      <description>
        <strong>ระดับความเร่งด่วน: </strong>
        {% if requisition.urgency %}
          {{requisition.urgency}}
        {%else%}
          {% for bu in baseUrgency %}
            {% if users.1.urgency == bu.id %}
              {{bu.name}} {{bu.description}}
            {% endif %}
          {% endfor %}
        {%endif%}
      </description>
    </div>
  </div>
  <hr>

  <div class="row">
    <div class="col-6">
      <description>
      <strong>ผู้ขอตั้งเบิก: </strong>{{requisition.name}}
      <br>
      <br>
      </description>
    </div>
    <div class="col-4 text-left">
        <description>
          <strong>ใบแจ้งซ่อมเลขที่: </strong><br>
          <br>
        </description>
    </div>
    <div class="col-2 text-right">
      <description>
        <strong>วันที่: </strong>{{requisition.created | date:"d/m/Y"}}<br>
        <br>
      </description>
    </div>
  </div>
  <div class="row">
    <div class="col-6">
      <description>
      <strong>ทะเบียนรถ/ เครื่องจักร/ หน่วยงาน: </strong>{% if requisition.car %}{{requisition.car}}{%endif%}
      <br>
      <br>
      </description>
    </div>
    <div class="col-3 text-left">
        <description>
          <strong>แผนกคชจ. </strong>{% if requisition.expense_dept %}{{requisition.expense_dept}}{%endif%}<br>
          <br>
        </description>
      </div>
    <div class="col-3 text-right">
      <description>
        <strong>
        </strong>
        {% for expense in requisition.expenses.all %}
          <i class="fas fa-circle"></i> {{ expense.name }}
        {% endfor %}
      </description>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <description>
        <strong>หมายเหตุ/เหตุผล: </strong>{% if requisition.note %}{{requisition.note}}{%endif%}
      </description>
    </div>
  </div>
  
  <div class="row my-3">
    <div class="col-md-12">
      <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">
                  <div class="row">
                    <div class="col-3">
                     <strong>รายการใบขอเบิก</strong> 
                    </div>
                    <div class="col-3 offset-4 hidden-print">
                    </div>
                    <div class="col-2">
                      <button type="button" style="float: right;" class="btn btn-success hidden-print" data-toggle="modal" data-target="#myModal-create">
                        <i class="fas fa-plus-circle"></i> เพิ่มรายการ
                      </button>
                    </div>
                  </div>
                </h3>
            </div>
        <div class="panel-body">
          <div class="table-responsive">
            <table id="userTable" class="table table-bordered">
              <thead>
                <tr>
                    <td class="text-center"><strong>ลำดับ</strong></td>
                    <td class="text-center"><strong>รหัสวัสดุ/อุปกรณ์</strong></td>
                    <td class="text-center"><strong>สินค้า</strong></td>
                    <!--td class="text-center"><strong>เหตุผลและวัตถุประสงค์</strong></td-->
                    <td class="text-center"><strong>จำนวนที่ขอเบิก</strong></td>
                    <td class="text-center"><strong>จำนวนที่จ่ายไป</strong></td>
                    <td class="text-center"><strong>หน่วย</strong></td>
                    <td class="text-center"><strong>วันที่ต้องการ</strong></td>
                    <td class="text-center"><strong>รายละเอียด/ประเภทการซ่อม</strong></td>
                    <!--
                    <td class="text-center"><strong>วันที่ต้องการ</strong></td>
                    <td class="text-center"><strong>ระดับความเร่งด่วน</strong></td>
                    -->
                    <td class="text-center hidden-print" colspan="2"><strong>Action</strong></td>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr id="user-{{user.id}}">
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td class="text-center userProduct userData" name="product"><b class="text-danger">{{user.alert_level}}</b>{{user.product.id}}</td>
                    <td class="userName userData" name="name"><form class="form-inline ml-3" id="search" method="GET"><b onClick="searchProduct('{{user.product_name}}')" data-target="#myEdit" data-toggle="modal" style="cursor: pointer;">{{user.product_name}}</b></form></td>
                    <td class="text-center userQuantity userData" name="quantity">{{user.quantity |floatformat:"-4"}}</td>
                    <td class="text-center userQuantityTake userData" name="quantityTake"><b onClick="editUser('{{user.id}}')" data-toggle="modal" data-target="#myModal" style="cursor: pointer;color:red;">{{user.quantity_take |floatformat:"-4"}}</b></td>
                    <td class="text-center userUnit userData" name="unit" data-val="{{user.unit}}">
                      {{user.unit}}
                    </td>
                    <td class="text-center userDesiredDate userData" name="desireddate">{{user.desired_date | date:"d/m/Y"}}</td>
                    <td class="text-center userDescription userData" name="description">{{user.description}}</td>
                    <!--
                    <td class="text-center userMachine userData" name="machine">{{user.machine}}</td>
                    <td class="text-center userDesiredDate userData" name="desireddate">{{user.desired_date | date:"d/m/Y"}}</td>
                    <td class="text-center userUrgency userData" name="urgency" data-val="{{user.urgency}}">
                      {% for bu in baseUrgency %}
                        {% if user.urgency == bu.id %}
                          {{bu.name}}
                        {% endif %}
                      {% endfor %}
                    </td>
                    -->
                    <td align="center" class="hidden-print">
                      <button class="btn btn-secondary form-control" onClick="editUser('{{user.id}}')" data-toggle="modal" data-target="#myModal" ><i class="fas fa-pen"></i></button>
                    </td>
                    <td align="center" class="hidden-print">
                      <button class="btn btn-danger form-control" onClick="deleteUser('{{user.id}}')"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="10" class="text-center ">
                    <div class="alert alert-warning" role="alert">
                      ไม่มีสินค้า
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <hr>
  <div class="row">
    <div class="col">
      <description>
      <strong>สาเหตุ: </strong>{% if requisition.broke_type %}{{requisition.broke_type}}{%endif%}
      </description>
    </div>
    {% if requisition.rq_type.id == 2 %}
    <div class="col-4 text-right">
      <description>
      <strong>เลขไมล์/เลขชั่วโมง: </strong>{{requisition.mile}}
      </description>
    </div>
    {%endif%}
  </div>
  <hr>
  <div class="row">
    <div class="col-4">
      <description>
      <strong>หัวหน้างาน: </strong>{{requisition.chief_approve_user_name}}
      </description>
    </div>
    <div class="col-4 text-center">
      <description>
        <strong>เจ้าหน้าที่พัสดุ: </strong>{{requisition.supplies_approve_user_name}}
      </description>
    </div>
    <div class="col-4 text-right">
      <h6>{{requisition.rq_type.iso_code}}</h6>
    </div>
  </div>
  <hr>
  <div class="row">
    {% if requisition.rq_type.id == 1 or requisition.rq_type.id == 2%}
    <div class="col text-danger">
      <b>หากมีการเบิกสินค้านี้ซ้ำ ในทะเบียนรถหรือเครื่องจักรเดียวกัน</b>
      <ul>
          <li>ภายใน 7 วัน ***</li>
          <li>ภายใน 15 วัน **</li>
          <li>ภายใน 30 วัน *</li>
      </ul>
    </div>
    {%endif%}
    <div class="col text-right">
      <description id="dt_print"></description>
    </div>
  </div>

  <div class="card bg-light my-3 hidden-print">
    <div class="card-body">
        {% if form.memorandum_pdf.errors %}
        <div class="alert alert-warning" role="alert">
            {{ form.memorandum_pdf.errors }}
        </div>
        {% endif %}
        <!--
        {% if form.name.errors %}
        <div class="alert alert-danger" role="alert">
            ชื่อผู้ขอตั้งเบิก {{ form.name.errors }}
        </div>
        {% endif %}
        {% if form.chief_approve_user_name.errors %}
        <div class="alert alert-danger" role="alert">
            ชื่อหัวหน้างาน {{ form.chief_approve_user_name.errors }}
        </div>
        {% endif %}
        -->
        <form method="post" enctype ="multipart/form-data">
            <!--
            <label for="id_name" class=" requiredField">
                ชื่อผู้ขอตั้งเบิก<span class="asteriskField">*</span>
            </label>
            <input id="rName" name="rName" type="text" list="idRequestNameList" class="form-control" Placeholder="ค้นหาชื่อผู้ขอตั้งเบิก ..." class="form-control" autocomplete="off" required>
            <datalist id="idRequestNameList">
                {% for results in requestName %}
                    <option data-id="{{results.id}}" value="{{results.first_name}} {{results.last_name}}"></option>
                {% endfor %}
            </datalist>
            <label for="id_name" class=" requiredField my-3">
                ชื่อหัวหน้างาน<span class="asteriskField">*</span>
            </label>
            <input id="cName" name="cName" type="text" list="idChiefNameList" class="form-control" Placeholder="ค้นหาชื่อหัวหน้างาน ..." class="form-control" autocomplete="off" required>
            <datalist id="idChiefNameList">
                {% for cResults in chiefName %}
                    <option data-id="{{cResults.id}}" value="{{cResults.first_name}} {{cResults.last_name}}"></option>
                {% endfor %}
            </datalist>          
            -->
            <p>{{ form | crispy}}</p>
            {% csrf_token %}
              <button type="submit" class="btn btn-warning hidden-print float-right">
                <i class="fas fa-save"></i>
                  บันทึกการแก้ไข
              </button>
        </form>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <a class="btn btn-primary hidden-print" href="{%url 'preparePR' %}" role="button"><i class="fas fa-plus-square"></i> สร้างใบขอซื้อ</a>
    </div>
    <div class="col text-right">
      <button type="button" class="btn btn-outline-info pull-right hidden-print my-2" onclick="scrollToTop();setDateTimePrint();window.print();">
        <i class="fas fa-print"></i>
        ปริ้นใบขอเบิก
      </button>
    </div>
  </div>
  </div>
  <!-- Modal Add-->
  <div class="modal fade" id="myModal-create" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header text-white" style="background-color:#82E0AA;">
          <h4 class="modal-title" id="myModalLabel">เพิ่มรายการสินค้า</h4>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <form id="addUser" action="">
          {% csrf_token %}
          <div class="modal-body">
            <div id="add_alert" class="alert alert-warning d-none" role="alert"></div><!-- แจ้งเตือนสินค้านี้ ออกใบขอเบิกล่าสุด -->
            <input class="form-control" type="checkbox" name="add_have_product"><!-- checkbox have product id -->
            <label for="product" class="text-success">รหัสวัสดุ/อุปกรณ์</label>
            <input name="product" type="text" list="idExpresslist" Placeholder="ค้นหารหัส express..." class="form-control is-valid" autocomplete="off" value="{{item.product.id}}" required onblur="setDataProductExpress(1);">
            <datalist id="idExpresslist">
            {% for results in baseProduct %}
              <option value="{{results.id}}">{{results.name}}</option>
            {% endfor %}
            </datalist>
            <label for="name">สินค้า/รายละเอียด</label>
            <input class="form-control" type="text" name="name_pd" required>
            <label for="name">จำนวนที่ขอเบิก</label>
            <input class="form-control" type="number" name="quantity" min="0.0001" required step="any">
            <label for="quantityTake" class="text-danger">จำนวนที่จ่ายไป (ออกใบจ่ายสินค้าภายใน)</label>
            <input class="form-control is-invalid" type="number" name="quantityTake" min="0" step="any" required/>
            <label for="name">หน่วย</label>
            <input class="form-control" list="unitList" name="unit" id="sel-unit" required>
            <datalist id="unitList">
              {% for unit in baseUnit %}
                <option data-id = "{{unit.id}}" value="{{unit.name}}">
              {% endfor %}
            </datalist>
            <!--
            <label for="name">เหตุผลและวัตถุประสงค์</label>
            <input class="form-control" type="text" name="description" required>
            <label for="name">ใช้ในระบบงาน(เครื่องจักร)</label>
            <input class="form-control" type="text" name="machine">
            <label for="name">วันที่ต้องการ</label>
            <input class="form-control dateinput form-control" type="date" name="desireddate"  placeholder="Select a date" onchange="selectedUrgency(this.name, 'sel-urgency');">
            <label for="name">ระดับความเร่งด่วน</label>
            <select id="sel-urgency" name="urgency" class="select form-control" required>
              <option value="" selected="">---------</option>
              {% for op in baseUrgency %}
              <option value="{{op.id}}">{{op.name}} {{op.description}}</option>
              {% endfor %}
            </select>
            -->
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" >บันทึก</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">ปิด</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Modal Edit-->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header text-white" style="background-color:#B2BABB;" >
          <h4 class="modal-title" id="myModalLabel">แก้ไขรายการสินค้า</h4>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <form id="updateUser" action="">
          {% csrf_token %}
        <div class="modal-body">
            <div id="update_alert" class="alert alert-warning d-none" role="alert"></div><!-- แจ้งเตือนสินค้านี้ ออกใบขอเบิกล่าสุด -->
            <input class="form-control" type="checkbox" name="update_have_product"><!-- checkbox have product id -->
            <input class="form-control" id="form-id" type="hidden" name="formId"/>
            <label for="formProduct" class="text-success">รหัสวัสดุ/อุปกรณ์</label>
            <input id="form-product" name="formProduct" type="text" list="idExpresslist" Placeholder="ค้นหารหัส express..." class="form-control is-valid" autocomplete="off" value="{{item.product.id}}" required onblur="setDataProductExpress(2);">
            <datalist id="idExpresslist">
            {% for results in baseProduct %}
              <option value="{{results.id}}">{{results.name}}</option>
            {% endfor %}
            </datalist>
            <label for="name">สินค้า/รายละเอียด</label>
            <input class="form-control" id="form-name" type="text" name="formName"/>
            <label for="quantity">จำนวนที่ขอเบิก</label>
            <input class="form-control" id="form-quantity" type="number" name="formQuantity" min="0.0001" step="any"/>
            <label for="quantityTake" class="text-danger">จำนวนที่จ่ายไป (ออกใบจ่ายสินค้าภายใน)</label>
            <input class="form-control is-invalid" id="form-quantitytake" type="number" name="formQuantityTake" min="0" step="any" required/>
            <label for="name">หน่วย</label>
            <input class="form-control" list="formUnitList" name="formUnit" id="form-unit" required>
            <datalist id="formUnitList">
              {% for unit in baseUnit %}
                <option data-id = "{{unit.id}}" value="{{unit.name}}">
              {% endfor %}
            </datalist>
            <!--
            <label for="description">เหตุผลและวัตถุประสงค์</label>
            <input class="form-control" id="form-description" type="text" name="formDescription"/>
            <label for="name">ใช้ในระบบงาน(เครื่องจักร)</label>
            <input class="form-control" type="text" id="form-machine" name="formMachine">
            <label for="name">วันที่ต้องการ</label>
            <input class="form-control dateinput form-control" type="date" id="form-desireddate" name="formDesiredDate"  placeholder="Select a date" onchange="selectedUrgency(this.name, 'form-urgency');">
            <label for="name">ระดับความเร่งด่วน</label>
            <select id="form-urgency" name="formUrgency" class="select form-control" required>
              <option value="" selected="">---------</option>
              {% for op in baseUrgency %}
              <option value="{{op.id}}">{{op.name}} {{op.description}}</option>
              {% endfor %}
            </select>
            -->
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary" >บันทึก</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">ปิด</button>
        </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Modal Search-->
  <div class="modal fade" id="myEdit" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">รายการสินค้าใน Express</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <p id="pShowSearch"></p>
          </div>
        </div>
    </div>
  </div>
{% endblock%}
{% block javascript %}
<!-- Select2 CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

<!-- Select2 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>

<script>
  //ดึงชื่อสินค้าและหน่วย จากที่ตั้งค่าไว้
  function setDataProductExpress(mode){
    if(mode == 1)
      var id_product = $('input[name="product"]').val().trim();
    else if(mode == 2)
      var id_product = $('#form-product').val().trim();

    if(id_product){
        // Create Ajax Call
        if(id_product){
            $.ajax({
            url: '{% url "setDataProductExpress" %}',
            data: {
                    'id_product': id_product,
                },
            dataType: 'json',
            success: function (data) {
              if(mode == 1){
                $('input[name="add_have_product"]').prop('checked', data.have_product);//set have product id in add
                if (data.exp_name) { //add
                  $('input[name="name_pd"]').val(data.exp_name);
                }
                if(data.exp_unit){
                  var selectedOption = $('#unitList option[data-id="'+data.exp_unit+'"]');
                  if (selectedOption.length) {
                    $('#sel-unit').val(selectedOption.attr('value'));
                  }
                }
                if(data.exp_alert){
                  $("#add_alert").removeClass("d-none");
                  $('#add_alert').text(data.exp_alert);
                }else{
                  $("#add_alert").addClass("d-none");
                }
              }else if(mode == 2){ //edit
                $('input[name="update_have_product"]').prop('checked', data.have_product);//set have product id in update
                if (data.exp_name) {
                  $('#form-name').val(data.exp_name);
                }
                if(data.exp_unit){
                  var selectedOption = $('#formUnitList option[data-id="'+data.exp_unit+'"]');
                  if (selectedOption.length) {
                    $('#form-unit').val(selectedOption.attr('value'));
                  }
                }
                if(data.exp_alert){
                  $("#update_alert").removeClass("d-none");
                  $('#update_alert').text(data.exp_alert);
                }else{
                  $("#update_alert").addClass("d-none");
                }
              }
            }
          });
        }
        return false;
    }
  }

    $('#id_car').select2({
        ajax: {
            url: "{% url 'car_search' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term, // search term
                    'rq_type': $('#id_rq_type').val(),
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        },
        placeholder: 'ค้นหาด้วย code หรือ ชื่อ',
        minimumInputLength: 2,
        allowClear: true
    });

$('div#div_id_memorandum_pdf a').addClass('btn btn-outline-success btn-sm');
$('div#div_id_memorandum_pdf a').text('Download');

//วันที่ต้องการ
$('#id_desired_date').val('{{requisition.desired_date|date:"Y-m-d"}}');

/*
$(function() {
    //get datalist to set input
    var idName = $("#id_name").val();
    var val = $('#idRequestNameList option[data-id='+idName+']').val();
    //set value to form.item
    $("#rName").val(val);

    //get datalist to set input
    var idChiefName = $("#id_chief_approve_user_name").val();
    var valC = $('#idChiefNameList option[data-id='+idChiefName+']').val();
    //set value to form.item
    $("#cName").val(valC);
});
*/

function searchProduct(name){
    var titleInput = name;
    if (titleInput) {
        // Create Ajax Call
        $.ajax({
            url: '{% url "searchItemExpress" %}',
            data: {
                'title': titleInput,
            },
            dataType: 'json',
            success: function (data) {
              if (data.instance) {
                openModal(data.instance);
                e.preventDefault();
              }else{
                $("#pShowSearch").html('ไม่พบสินค้าที่ค้นหา');
              }
            }
        });
    } else {
      
    }
    return false;
  }

function openModal(instance) {
  $("#pShowSearch").html(instance);
  $('#myEdit').modal('show');
}

// Create Django Ajax Call
$(function(){
$(document).on('submit','form#addUser',function(){
    var nameInput = $('input[name="name_pd"]').val().trim();
    var unitInput = $('#sel-unit').val();
    var quantityInput = $('input[name="quantity"]').val().trim();
    var quantityTakeInput = $('input[name="quantityTake"]').val().trim();
    var machineInput = '';
    var desireddateInput = '';
    var urgencyInput = '';
    var descriptionInput = '';
    var productInput = $('input[name="product"]').val().trim(); //product_id
    var have_product = $('input[name="add_have_product"]').is(":checked"); //สถานะว่ามีรหัสสินค้าในระบบ

    /*
    var machineInput = $('input[name="machine"]').val().trim();
    var desireddateInput = $('input[name="desireddate"]').val();
    var urgencyInput = $('#sel-urgency').val();
    var quantityInput = $('input[name="quantity"]').val().trim();
    if (desireddateInput == '')
      desireddateInput = null;
    */
    if (nameInput && quantityInput && have_product) {
        // Create Ajax Call
        $.ajax({
            url: '{% url "crud_ajax_create" requisition.id %}',
            data: {
                'name': nameInput,
                'description': descriptionInput,
                'quantity': quantityInput,
                'quantity_take': quantityTakeInput,
                'machine': machineInput,
                'desired_date': desireddateInput,
                'unit': unitInput,
                'urgency':urgencyInput,
                'product': productInput,
            },
            dataType: 'json',
            success: function (data) {
                if (data.user) {
                  e.preventDefault();
                  appendToUsrTable(data.user);
                }
            }
        });

      $('form#addUser').trigger("reset");
      $(this).find('form#addUser')[0].reset();
      $('#myModal-create').modal('hide');
      window.location.reload();
    } else {
      alert("ไม่มีรหัสสินค้านี้ในระบบ กรุณาเปลี่ยนรหัสสินค้า");
    }
    return false;
  });
});


// Delete Django Ajax Call
function deleteUser(id) {
  var action = confirm("คุณต้องการลบสินค้านี้หรือไม่?");
  if (action != false) {
    $.ajax({
        url: '{% url "crud_ajax_delete" %}',
        data: {
            'id': id,
        },
        dataType: 'json',
        success: function (data) {
            if (data.deleted) {
              $("#userTable #user-" + id).remove();
            }
        }
    });
  }
}


// Create Django Ajax Call
$(function(){
$(document).on('submit','form#updateUser',function(){
    var idInput = $('input[name="formId"]').val().trim();
    var nameInput = $('input[name="formName"]').val().trim();
    var quantityInput = $('input[name="formQuantity"]').val().trim();
    var quantityTakeInput = $('input[name="formQuantityTake"]').val().trim();
    var unitInput = $('#form-unit').val();
    var machineInput = '';
    var desireddateInput = '';
    var urgencyInput = '';
    var descriptionInput = '';
    var productInput = $('input[name="formProduct"]').val().trim();
    var have_product = $('input[name="update_have_product"]').is(":checked"); //สถานะว่ามีรหัสสินค้าในระบบ
    /*
    var machineInput = $('input[name="formMachine"]').val().trim();
    var desireddateInput = $('input[name="formDesiredDate"]').val();
    var urgencyInput = $('#form-urgency').val();
    var descriptionInput = $('input[name="formDescription"]').val().trim();
    */

    if (nameInput && quantityInput && have_product) {
        // Create Ajax Call
        $.ajax({
            url: '{% url "crud_ajax_update" requisition.id %}',
            data: {
                'id': idInput,
                'name': nameInput,
                'description': descriptionInput,
                'quantity': quantityInput,
                'quantity_take': quantityTakeInput,
                'machine': machineInput,
                'desired_date': desireddateInput,
                'unit': unitInput,
                'urgency':urgencyInput,
                'product' : productInput,
            },
            dataType: 'json',
            success: function (data) {
                if (data.user) {
                  e.preventDefault();
                  updateToUserTabel(data.user);
                }
            }
        });

      $('form#updateUser').trigger("reset");
      $(this).find('form#updateUser')[0].reset();
      $('#myModal').modal('hide');
      window.location.reload();
    } else {
      alert("ไม่มีรหัสสินค้านี้ในระบบ กรุณาเปลี่ยนรหัสสินค้า");
    }
    return false;
  });
});


// Update Django Ajax Call
function editUser(id) {
  if (id) {
    tr_id = "#user-" + id;
    name = $(tr_id).find(".userName").text();
    description = $(tr_id).find(".userDescription").text();
    quantity = $(tr_id).find(".userQuantity").text();
    quantityTake = $(tr_id).find(".userQuantityTake").text();
    machine = $(tr_id).find(".userMachine").text();
    desireddate_str = $(tr_id).find(".userDesiredDate").text();
    desireddateObject = desireddate_str.split("/").reverse().join("-");
    unit = $(tr_id).find(".userUnit").data('val');
    urgency = $(tr_id).find(".userUrgency").data('val');
    product = $(tr_id).find(".userProduct").text().split("*").reverse().join(""); //product_id
    
    $('#form-id').val(id);
    $('#form-name').val(name);
    $('#form-description').val(description);
    $('#form-quantity').val(quantity);
    $('#form-quantitytake').val(quantityTake);
    $('#form-machine').val(machine);
    $('#form-desireddate').val(desireddateObject);
    $('#form-unit').val(unit);
    $('#form-urgency').val(urgency);
    $('#form-product').val(product);
  }
}

function appendToUsrTable(user) {
  $("#userTable > tbody:last-child").append(`
        <tr id="user-${user.id}">
            <td class="text-center userName" name="name_pd">${user.name}</td>
            '<td class="text-center userDescription" name="description">${user.description}</td>
            '<td class="text-center userQuantity" name="quantity">${user.quantity}</td>
            '<td class="text-center userQuantityTake" name="quantityTake">${user.quantity_take}</td>
            '<td class="text-center userUnit" name="unit">${user.unit}</td>
            '<td class="text-center userMachine" name="machine">${user.machine}</td>
            '<td class="text-center userDesiredDate" name="desireddate">${user.desired_date}</td>
            '<td class="text-center userUrgency" name="urgency">${user.urgency}</td>
            '<td align="center" class="hidden-print">
                <button class="btn btn-secondary form-control" onClick="editUser(${user.id})" data-toggle="modal" data-target="#myModal")"><i class="fas fa-pen"></i></button>
            </td>
            <td align="center" class="hidden-print">
                <button class="btn btn-danger form-control" onClick="deleteUser(${user.id})"><i class="fas fa-trash-alt"></i></button>
            </td>
        </tr>
    `);
    window.location.reload();
}

function updateToUserTabel(user){
    $("#userTable #user-" + user.id).children(".userData").each(function() {
        var attr = $(this).attr("name");
        if (attr == "name") {
          $(this).text(user.name);
        } else if (attr == "description") {
          $(this).text(user.description);
        } else if (attr == "quantity"){
          $(this).text(user.quantity);
        } else if (attr == "quantityTake"){
          $(this).text(user.quantity_take);
        } else if (attr == "machine"){
          $(this).text(user.machine);
        } else if (attr == "desireddate"){
          $(this).text(user.desired_date);
        } else if (attr == "unit"){
          $(this).text(user.unit);
        }else if (attr == "urgency"){
          $(this).text(user.urgency);
        }else if (attr == "product"){
          $(this).text(user.product);
        }
      });
      window.location.reload();
}
function parseDate(str) {
    var mdy = str.split('-');
    return new Date(mdy[0], mdy[1]-1, mdy[2]);
}

function datediff(first, second) {
    // Take the difference between the dates and divide by milliseconds per day.
    // Round to nearest whole number to deal with DST.
    return Math.round((second-first)/(1000*60*60*24));
}

function showDayDiff(name){
  var dateNow = new Date();
  var desireddateInput = $('input[name="'+name+'"]').val();
  var daydiff = datediff(dateNow, parseDate(desireddateInput));
  return daydiff;
}

function selectedUrgency(name, id){
  var day = showDayDiff(name);
  if(day == 0 | day == 1){
    document.getElementById(id).selectedIndex = 1;
  }else if(day > 1 & day < 5){
    document.getElementById(id).selectedIndex = 2;
  }else if(day > 4 & day < 7){
    document.getElementById(id).selectedIndex = 3;
  }else if(day > 6){
    document.getElementById(id).selectedIndex = 4;
  }else{
    
  }
}

/*
//ผู้ขอตั้งเบิก
$("#rName").change(function() {
    // get data id ของ option data list
    var val = $("#rName").val();
    var id = $("#idRequestNameList option[value='"+val+"']").attr('data-id');

    //set value to form.item
    $("#id_name").val(id);
});

  //หัวหน้างาน
  $("#cName").change(function() {
    // get data id ของ option data list
    var val = $("#cName").val();
    var id = $("#idChiefNameList option[value='"+val+"']").attr('data-id');

    //set value to form.item
    $("#id_chief_approve_user_name").val(id);
  });
*/

  $("#id_rq_type").change(function() {
    rqType_Change();
  });

  function rqType_Change(){
    //เคลียร์ค่าเครื่องจักร/ทะเบียนรถ หากเปลี่ยนประเภทใบขอเบิก
    $("#id_car").find('option').remove();

    if ($("#id_rq_type").val() == ""){
        $("#div_id_repair_type").addClass("d-none");
        $("#div_id_car").addClass("d-none");
        $("#div_id_broke_type").addClass("d-none");
        //เลขไมล์
        $("#div_id_mile").addClass("d-none");
        $("#id_mile").prop('required',false);
        $("#id_mile").val("");
    }
    else if($("#id_rq_type").val() == 2){
        $("#div_id_repair_type").removeClass("d-none");
        $("#div_id_car").removeClass("d-none");
        $("#div_id_broke_type").removeClass("d-none");
        //เลขไมล์
        $("#div_id_mile").removeClass("d-none");
        $("#id_mile").prop('required',true);
    }
    else{
        $("#div_id_repair_type").removeClass("d-none");
        $("#div_id_car").removeClass("d-none");
        $("#div_id_broke_type").removeClass("d-none");
        //เลขไมล์
        $("#div_id_mile").addClass("d-none");
        $("#id_mile").prop('required',false);
        $("#id_mile").val("");

        searchRepairType();
    }
  }

  $("#id_agency").change(function() {
    agency_Change();
  });

  function agency_Change(){
    if ($("#id_agency").val() == ""){
        $("#div_id_expense_dept").addClass("d-none");
    }
    else{
        $("#id_agency").removeClass("d-none");
        $("#div_id_expense_dept").removeClass("d-none");
        searchExpenseDept();
    }
  }

  function searchRepairType(){
    var tempRepairType = $("#id_repair_type").val();

    if($('#id_rq_type').val() != ""){
      var idInput = $('#id_rq_type').val();

      // Create Ajax Call
      if(idInput){
        //set id_rq_type
        $.ajax({
          url: '{% url "searchRepairType" %}',
          data: {
            'rq_type': idInput,
          },
          dataType: 'json',
          success: function (data) {
            if (data.repair_type_list) {
              $("#id_repair_type").find('option').not(':first').remove();
              //set option 
              for(var i = 0; i < data.repair_type_list.length; i++){
                $("#id_repair_type").append(new Option(data.repair_type_list[i].name, data.repair_type_list[i].id));
              }
            }
            $('#id_repair_type option[value="'+tempRepairType+'"]').attr('selected','selected');
          }
        });
      }
      return false;
      }else{
        $("#id_repair_type").find('option').not(':first').remove();
      }
  }

  function searchExpenseDept(){
        var tempExpenseDept = $("#id_expense_dept").val();

        if($('#id_agency').val() != ""){
            var idInput = $('#id_agency').val();

            // Create Ajax Call
            if(idInput){
                //set id_rq_type
                $.ajax({
                    url: '{% url "searchExpenseDept" %}',
                    data:{
                            'agency': idInput,
                        },
                    dataType: 'json',
                    success: function (data) {
                        if (data.expense_dept_list) {
                                $("#id_expense_dept").find('option').not(':first').remove();
                                //set option 
                                for(var i = 0; i < data.expense_dept_list.length; i++){
                                    $("#id_expense_dept").append(new Option(data.expense_dept_list[i].name, data.expense_dept_list[i].id));
                                }
                        }
                        $('#id_expense_dept option[value="'+tempExpenseDept +'"]').attr('selected','selected');
                    }
                });
            }
            return false;
        }else{
            $("#id_expense_dept").find('option').not(':first').remove();
        }
    }

    //after load
    $(document).ready(function() {
        $('#id_name').select2();
        $('#id_chief_approve_user_name').select2();
        $('#id_repair_type').select2();
        $('#id_expense_dept').select2();

        //เส้น
        $('#div_id_expense_dept').after("<hr class='my-4' style='border: 1px solid #7DCEA0; border-radius: 1px;'>");
        $('#div_id_urgency').after("<hr class='my-4' style='border: 1px solid #7FB3D5; border-radius: 1px;'>");

        $('input[type="checkbox"]').addClass('big-checkbox');
        $('.form-check').addClass('inline-checkboxes');

        agency_Change();

        //ถ้าไม่ใช่ประเภทใบขอเบิก รถ/เครื่องจักรหนัก ไม่ต้องโชว์ช่อง เลขไมล์
        if($("#id_rq_type").val() != 2)
          $("#div_id_mile").addClass("d-none");

    });

    //ระดับความเร่งด่วน
    $("#id_desired_date").change(function() {
        selectedUrgency('desired_date', 'id_urgency');
    });

  function setDateTimePrint(){
    var currentdate = new Date();
    var datetime = "@ " + currentdate.toLocaleString('th-TH', { dateStyle: 'long', timeStyle: 'medium' })+ " (" + "{{request.user}}"+ ")";
    $("#dt_print").text(datetime);
  }

</script> 
{% endblock %}
